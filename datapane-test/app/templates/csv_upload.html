{% extends "base.html" %}

{% block title %}
CSV Uploader Page
{% endblock %}

{% block content %}

<div id="csv-upload"></div>
<div id="handsontable-container"></div>
{%  endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/handsontable/0.28.4/handsontable.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
<script type="text/babel">
var handsontableContainer = document.getElementById('handsontable-container')

class CSVUpload extends React.Component {
constructor(props){
  super(props);
  this.state = {
    file: null,
    fileUploaded: false
  };
  this.handleChange = this.handleChange.bind(this);
  this.onFormSubmit = this.onFormSubmit.bind(this);
  this.fileUpload = this.fileUpload.bind(this);
  this.addNewButton = this.addNewButton.bind(this);
}

handleChange(event){
  var file = event.target.files[0];
  var reader = new FileReader();

  reader.onload = function (evt) {
    var csv = evt.target.result;
    var data = Papa.parse(csv, {
      header: true,
      skipEmptyLines: true
    });

    // reset container
    handsontableContainer.innerHTML = '';
    handsontableContainer.className = '';

    Handsontable(handsontableContainer, {
      data: data.data,
      rowHeaders: true,
      colHeaders: data.meta.fields,
      columnSorting: true,
      licenseKey: 'non-commercial-and-evaluation',
      filters:true
    })
  }

  reader.readAsText(file);
  this.setState({file});
}

onFormSubmit(evt){
  evt.preventDefault()
  this.setState({
    fileUploaded: true
  })
  handsontableContainer.innerHTML = ''
  handsontableContainer.className = ''

  this.fileUpload(this.state.file).then((response)=>{
    console.log(response);
  })
}

fileUpload(file){
  const url = {% url 'csv_uploader' %};
  const formData = new FormData();
  formData.append('file',file);
  const config = {
    headers: {
      'content-type': 'multipart/form-data'
    }
  };
  return  axios.post(url, formData,config)
}

addNewButton(){
  this.setState({
    fileUploaded: false
  })
}

render() {
  return (
          <div>

            {this.state.fileUploaded ?
                    <div>
                        <p>File Uploaded Successfully</p>
                        <button className="btn btn-primary" onClick={this.addNewButton}>Add new</button>
                    </div>
              : <form onSubmit={this.onFormSubmit}>
                        <h3>
                            File upload
                            <small className="text-muted"> Only CSV supported</small>
                        </h3>
                        <label className="custom-file-upload">
                            <input className="btn" type="file" id="input-file" accept=".csv" onChange={this.handleChange} />
                            <button className="btn btn-primary" type="submit">Upload</button>
                        </label>


                    </form>}

          </div>
  )
}
}
ReactDOM.render(
      <CSVUpload />,
document.getElementById('csv-upload')
);
</script>

{% endblock %}